#!/bin/env bash

BACKGROUND=false
NO_SOUND=false
SOUND_FILE=""
VOLUME=""
STOPWATCH=0
POSITIONAL_ARGS=()

while [[ "$#" -gt 0 ]]; do
  case $1 in
  -h | --help)
    echo "Usage: timer [OPTIONS] TIME_OR_SECONDS [NOTIF_BODY] [NOTIF_TITLE]"
    echo
    echo "Options:"
    echo "  -s, --stopwatch        Run as stopwatch (counts up)"
    echo "  -b, --background       Run in background"
    echo "  -n, --no-sound         Disable alarm sound"
    echo "  -f, --sound-file PATH  Custom sound file to loop"
    echo "  -v, --volume VOL       Set volume"
    echo "  -h, --help             Show this help message"
    echo
    echo "TIME_OR_SECONDS can be in the format HH:MM, HH:MM:SS, HH:MMam/pm or seconds."
    exit 0
    ;;
  -s | --stopwatch) STOPWATCH=1 ;;
  -b | --background) BACKGROUND=true ;;
  -n | --no-sound) NO_SOUND=true ;;
  -f | --sound-file)
    shift
    SOUND_FILE="$1"
    if [ ! -f "$SOUND_FILE" ]; then
      echo "Sound file not found: $SOUND_FILE"
      exit 1
    fi
    ;;
  -v | --volume)
    shift
    VOLUME="$1"
    if ! [[ "$VOLUME" =~ ^[0-9]+$ ]] || [ "$VOLUME" -lt 1 ]; then
      echo "Volume must be greater than 0"
      exit 1
    fi
    ;;
  -*)
    echo "Unknown option: $1"
    exit 1
    ;;
  *)
    POSITIONAL_ARGS+=("$1")
    ;;
  esac
  shift
done

if [ $STOPWATCH -eq 1 ]; then
  end=$(date +%s)
  while true; do
    time=$(($(date +%s) - end))
    printf '%s\r' "$(date -u -d "@$time" +%H:%M:%S)"
    sleep 0.5
  done
fi

TIME_OR_SECONDS="${POSITIONAL_ARGS[0]}"
NOTIF_BODY="${POSITIONAL_ARGS[1]}"
NOTIF_TITLE="${POSITIONAL_ARGS[2]:-"Time's up!"}"

if [ -z "$TIME_OR_SECONDS" ]; then
  echo "Invalid input"
  exit 1
fi

if [[ "$TIME_OR_SECONDS" == *:* ]]; then
  target_datetime="$(date +'%Y-%m-%d') $TIME_OR_SECONDS"
  if ! target_epoch=$(date -d "$target_datetime" +%s 2>/dev/null); then
    echo "Invalid input: use HH:MM, HH:MM:SS, HH:MMam/pm or seconds"
    echo "See 'date --help' for more information on valid time formats."
    exit 1
  fi
  SECONDS=$((target_epoch - $(date +%s)))

  if [ "$SECONDS" -lt 0 ]; then
    echo "Time $TIME_OR_SECONDS has already passed today"
    exit 1
  fi
elif [[ "$TIME_OR_SECONDS" =~ ^[0-9]+$ ]] && [ "$TIME_OR_SECONDS" -gt 0 ]; then
  SECONDS="$TIME_OR_SECONDS"
else
  echo "Invalid input: use HH:MM, HH:MM:SS, HH:MMam/pm or seconds"
  exit 1
fi

if [ "$BACKGROUND" = true ]; then
  nohup "$0" ${NO_SOUND:+-n} "$@" >/dev/null 2>&1 &
  exit 0
fi

# main timer loop
end=$(($(date +%s) + $SECONDS))
while [ "$end" -ge $(date +%s) ]; do
  time="$(($end - $(date +%s)))"
  [ "$BACKGROUND" = false ] && printf '%s\r' "$(date -u -d "@$time" +%H:%M:%S)" && sleep 0.5
done

if [ "$NO_SOUND" = false ]; then
  VOLUME_FLAG=""
  if [ -n "$VOLUME" ]; then
    VOLUME_FLAG="--volume=$((VOLUME * 655))"
  fi

  if [ -n "$SOUND_FILE" ]; then
    while :; do
      /usr/bin/paplay $VOLUME_FLAG "$SOUND_FILE"
    done &
    SOUND_LOOP_PID=$!
  else
    while :; do
      timeout 2 /usr/bin/paplay $VOLUME_FLAG /usr/share/sounds/freedesktop/stereo/service-login.oga
      timeout 2 /usr/bin/paplay $VOLUME_FLAG /usr/share/sounds/freedesktop/stereo/service-logout.oga
    done &
    SOUND_LOOP_PID=$!
  fi
fi

notify-send -u critical -w "$NOTIF_TITLE" "$NOTIF_BODY"

if [ "$NO_SOUND" = false ]; then
  kill $SOUND_LOOP_PID
fi
